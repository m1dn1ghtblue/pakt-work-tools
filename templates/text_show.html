{%extends "base.html"%} {% load static %} {% block link %}
<link rel="stylesheet" type="text/css" href="{% static 'css/text_show_legacy.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/work_area_legacy.css' %}" />
{% endblock link %} {%block plugins%}
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="{% static 'js/work_area.js' %}"></script>
{%endblock plugins%} {%block content%} {%if exists %} {%if ann_right%}
<div id="annotation-create-form-area">
	{#Блок для формы созданя/редактирования аннотаций#} {%block annotation_edit_form_html%}{%endblock%}
</div>
{%else%}
<div id="annotation-create-form-area">
	{#Блок для формы созданя/редактирования аннотаций#} {%block annotation_watch_form_html%}{%endblock%}
</div>
{%endif%}
<div id="text-path">{{lang_name}}/{{text_info.text_type}}/{{text_info.text_name}}</div>

<!--Меню текста-->
<div id="over-text btn-group">
	<!--Настройка вида-->
	<button type="button" class="btn shadow-none mbtn dropdown" data-bs-toggle="dropdown" aria-expanded="false">
		Вид
	</button>
	<ul class="dropdown-menu">
		<li><h6 class="dropdown-header">Язык разметки</h6></li>
		<li>
			<div class="dropdown-item-text mfield" id="lang-change-area" v-on:change="ChangeLang">
				<select id="lang-select">
					<option id="foreign-option" value="0">{{lang_name}}</option>
					<option id="russian-option" value="1">Русский</option>
				</select>
			</div>
		</li>
		<li><h6 class="dropdown-header">Компактный вид</h6></li>
		<li>
			<div class="dropdown-item-text mfield">
				<div class="form-check form-switch">
					<input class="form-check-input" type="checkbox" id="tag-style" v-on:click="SwitchTagStyle" />
				</div>
			</div>
		</li>
		<li><h6 class="dropdown-header">Части речи</h6></li>
		<li>
			<div class="dropdown-item-text mfield">
				<div class="form-check form-switch">
					<input class="form-check-input" type="checkbox" id="show-pos" v-on:click="SwitchPos" />
				</div>
			</div>
		</li>
		<li><h6 class="dropdown-header">Ошибки</h6></li>
		<li>
			<div class="dropdown-item-text mfield">
				<div class="form-check form-switch">
					<input class="form-check-input" type="checkbox" id="show-error" v-on:click="SwitchError" checked />
					<!-- <label class = "mflabel">Ошибки</label> -->
				</div>
			</div>
		</li>
	</ul>

	<!--Информация о тексте-->
	<button type="button" class="btn shadow-none mbtn dropdown" data-bs-toggle="dropdown" aria-expanded="false">
		Текст
	</button>
	<ul class="dropdown-menu">
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Курс создания: </label>
				{{text_info.course}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Дата создания: </label>
				{{text_info.create_date}}
			</div>
		</li>
		<li><hr class="dropdown-divider" /></li>
		<li>
			<div class="dropdown-item-text mfield">
				<a href="{% url 'show_raw' text_id=text_id %}" class="btn shadow-none update-button text-menu-btn"
					>Исходный текст</a
				>
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield" id="update_part_of_speech_btn">
				<a
					href="#"
					class="btn shadow-none update-button text-menu-btn"
					onclick="process_part_of_speech(event, '{{language}}', '{{text_type}}', '{{text_id}}')"
				>
					Обновление частей речи
				</a>
			</div>
		</li>
		{%if superuser%}
		<li>
			<div class="dropdown-item-text mfield">
				<form method="post" novalidate action="{% url 'delete_text' %}">
					<input type="hidden" name="text_id" value="{{ text_id }}" />
					<button
						type="submit"
						class="btn shadow-none del-button text-menu-btn"
						id="del-text-btn"
						style="border-radius: 0"
						onclick="return confirm('Удалить текст?')"
					>
						Удалить текст
					</button>
				</form>
			</div>
		</li>
		{%endif%}
	</ul>

	<!--Информация об авторе-->
	<button type="button" class="btn shadow-none mbtn dropdown" data-bs-toggle="dropdown" aria-expanded="false">
		Автор
	</button>
	<ul class="dropdown-menu">
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Имя: </label>
				{{text_info.author_name}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Группа: </label>
				{{text_info.group_number}}
			</div>
		</li>
		{%if text_owner or teacher%}
		<li><hr class="dropdown-divider" /></li>
		<li>
			<div class="dropdown-item-text mfield">
				<a href="{%url 'author_edit' text_id=text_id %}" class="btn shadow-none update-button text-menu-btn"
					>Изменить</a
				>
			</div>
		</li>
		{%endif%}
	</ul>

	<!--Метаданные-->
	<button type="button" class="btn shadow-none mbtn dropdown" data-bs-toggle="dropdown" aria-expanded="false">
		Метаданные
	</button>
	<ul class="dropdown-menu">
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Эмоционально-физиологическое состояние: </label>
				{{text_info.emotional}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Место написания: </label>
				{{text_info.write_place}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Год изучения языка: </label>
				{{text_info.education_level}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Самооценивание: </label>
				{{text_info.self_rating}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Оценка задания студентом: </label>
				{{text_info.student_assessment}}
			</div>
		</li>
		{%if text_owner%}
		<li><hr class="dropdown-divider" /></li>
		<li>
			<div class="dropdown-item-text mfield">
				<a href="{%url 'meta_edit' text_id=text_id%}" class="btn shadow-none update-button text-menu-btn"
					>Изменить</a
				>
			</div>
		</li>
		{%endif%}
	</ul>

	<!--Проверка работы-->
	<button type="button" class="btn shadow-none mbtn dropdown" data-bs-toggle="dropdown" aria-expanded="false">
		Проверка
	</button>
	<ul class="dropdown-menu">
		<li><h6 class="dropdown-header">Оценка работы</h6></li>
		{%if text_info.assessment%}
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Оценка: </label>
				{{text_info.assessment}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Полнота: </label>
				{{text_info.completeness}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Структура: </label>
				{{text_info.structure}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Связность: </label>
				{{text_info.coherence}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Проверяющий: </label>
				{{text_info.teacher_name}}
			</div>
		</li>
		{%else%}
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Оценка: </label>
				Не указано
			</div>
		</li>
		{%endif%}

		<li><h6 class="dropdown-header">Частеречная разметка</h6></li>
		{%if text_info.pos_check%}
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Статус: </label>
				<font style="color: var(--color-accept)">Проверено</font>
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Проверяющий: </label>
				{{text_info.pos_check_name}}
			</div>
		</li>
		{%else%}
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Статус: </label>
				<font style="color: var(--color-warning)">Не проверено</font>
			</div>
		</li>
		{%endif%}

		<li><h6 class="dropdown-header">Разметка ошибок</h6></li>
		{%if text_info.error_check%}
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Статус: </label>
				<font style="color: var(--color-accept)">Проверено</font>
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Проверяющий: </label>
				{{text_info.error_check_name}}
			</div>
		</li>
		{%else%}
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Статус: </label>
				<font style="color: var(--color-warning)">Не проверено</font>
			</div>
		</li>
		{%endif%} {%if ann_right%}
		<li><hr class="dropdown-divider" /></li>
		<li>
			<div class="dropdown-item-text mfield">
				<a href="{% url 'asses_edit' text_id=text_id %}" class="btn shadow-none update-button text-menu-btn"
					>Изменить</a
				>
			</div>
		</li>
		{%endif%}
	</ul>

	<!--Автооценка-->
	{% if auto_degree%}
	<button type="button" class="btn shadow-none mbtn dropdown" data-bs-toggle="dropdown" aria-expanded="false">
		Автооценка
	</button>
	<ul class="dropdown-menu">
		<li><h6 class="dropdown-header">Грамматика</h6></li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Степень 1: </label>
				{{auto_grammatik.0}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Степень 2: </label>
				{{auto_grammatik.1}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Степень 3: </label>
				{{auto_grammatik.2}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Оценка: </label>
				{{auto_grammatik.3}}
			</div>
		</li>

		<li><h6 class="dropdown-header">Лексика</h6></li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Степень 1: </label>
				{{auto_lexik.0}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Степень 2: </label>
				{{auto_lexik.1}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Степень 3: </label>
				{{auto_lexik.2}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Оценка: </label>
				{{auto_lexik.3}}
			</div>
		</li>

		<li><h6 class="dropdown-header">Орфография и пунктуация</h6></li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Степень 1: </label>
				{{auto_orth.0}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Степень 2: </label>
				{{auto_orth.1}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Степень 3: </label>
				{{auto_orth.2}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Оценка: </label>
				{{auto_orth.3}}
			</div>
		</li>

		<li><h6 class="dropdown-header">Подсчёт ошибок</h6></li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Дискурс: </label>
				{{count_dis}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Пропуски: </label>
				{{count_skip}}
			</div>
		</li>
		<li>
			<div class="dropdown-item-text mfield">
				<label class="mflabel">Лишние элементы: </label>
				{{count_extra}}
			</div>
		</li>
	</ul>

	{%endif%}
</div>
<div class="text-place">
	<table class="text-area"></table>
</div>
{%else%}
<div id="found-text-error">Текст не найден</div>
{%endif%} {%endblock content%}

<!-- Script -->
{%block script%}
<script>
	document.body.onmousedown = function(eventData) {
	if (eventData.button === 0) {
	    key_down=true}
	}
	document.body.onmouseup = function(eventData) {
	if (eventData.button === 0) {
	    key_down=false}
	}

	function process_part_of_speech(eventData, language, text_type, text_id) {
	    // функция отправки запроса на обновление частеречной разметки текста
	    eventData.preventDefault();

	    if (!window.confirm("Вы действительно желаете обновить частеречную разметку? Старая разметка будет удалена")) {
	        return;
	    }

	    document.getElementById("update_part_of_speech_btn").style.display = 'none';

	    let process_url = "{% url 'part_of_speech' %}";
	    fetch(process_url, {
	        method: 'POST',
	        body: JSON.stringify({language, text_type, text_id})
	    }).then(
	        response => {
	            if (response.ok) {
	                console.log("SUCCESS");
	                window.alert("Частеречная разметка обновлена!");
	                document.getElementById("update_part_of_speech_btn").style.display = 'block';
	                return;
	            } else {
	                window.alert("Ошибка разметки текста: " + response.statusText)
	            }
	            console.log(response);
	        }, networkError => {
	            window.alert("Ошибка разметки текста: " + networkError.message)
	            console.log(networkError.message);
	        }
	    );
	}

	{% if ann_right %}
	{#режим редактирования аннотации (1-создание, 2-обновление)#}
	var selected_tag = 0 //Удалить
	var get_classification_url = "{% url 'get_classification' %}"
	var add_empty_token_url = "{% url 'add_empty_token' %}"
	var selected_tokens = []
	{%endif%}
	var markups_info = new Map()
	var text_id = {{text_id}}
	var language = 0
	var get_text_url = "{%url 'get_text' %}"
	var edit_ann_url = "{%url 'annotation_edit' %}"

	var key_down = false
	var text_response = null
	var classification_response = null

	{#Используемые функции#}
	{%block functions%}{%endblock%}

	{%if ann_right%}
	{#Создание формы#}
	{%block annotation_edit_form_script%}{%endblock%}
	{%endif%}

	{%if ann_right%}

	get_classification()
	{%endif%}
	{%block get_text%}{%endblock%}
	get_text()
	{%block bone_funcs%}{%endblock%}
	{%if ann_right%}
	var save_button = new Vue({
	    el:"#form-save-button",
	    methods:{
	        Save: function(){sent_annotation_info(edit_ann_url)
	    }
	}
	})
	var save_button = new Vue({
	    el:"#form-delete-button",
	    methods:{
	        Delete: function(){delete_annotation_info(edit_ann_url)
	    }
	}
	})
	{%endif%}
	var annotation_create_form_close = new Vue({
	    el: "#annotation-create-form-close",
	    methods :{
	        CloseAnnCreateForm: close_ann_create_form
	    }
	})
	var lang_changers = new Vue({
	    el:"#lang-change-area",
	    methods:{
	        ChangeLang:reset_language
	    }
	})
	var switchtagstyle = new Vue({
	    el:"#tag-style",
	    methods:{
	        SwitchTagStyle: function change_tag_style(event){
	            var tags = document.querySelectorAll('[annotation-type="1"][annotation-position="start"],[annotation-type="1"][annotation-position="single"]')
	            if(compact_style ==0 ){
	                compact_style = 1
	                console.log(tags[1].innerHTML)
	                for(let i = 0; i < tags.length; i++){
	                    var new_name = tags[i].getAttribute('name-abbrev')
	                    tags[i].innerHTML = new_name
	                }
	            }
	            else{
	                compact_style = 0
	                for(let i = 0; i < tags.length; i++){
	                    var new_name = tags[i].getAttribute('current-name')
	                    tags[i].innerHTML = new_name
	                }
	            }
	        }
	    }
	})
	var switchpos = new Vue({
	    el:"#show-pos",
	    methods:{
	        SwitchPos: function(event){
	            var html_tags = document.querySelectorAll('[annotation-type = "2"]')
	            var display_value = "none"
	            if(event.currentTarget.checked){
	                display_value = "block"
	            }
	            for(var i=0; i<html_tags.length;i++){
	                html_tags[i].style.display = display_value
	            }

	        }
	    }
	})
	var switcherr = new Vue({
	    el:"#show-error",
	    methods:{
	        SwitchError: function(event){
	            var html_tags = document.querySelectorAll('[annotation-type = "1"]')
	            var display_value = "none"
	            if(event.currentTarget.checked){
	                display_value = "block"
	            }
	            for(var i=0; i<html_tags.length;i++){
	                html_tags[i].style.display = display_value
	            }

	        }
	    }
	})
</script>
{%endblock script%}
