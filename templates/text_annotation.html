{% extends "base.html" %} {% load static %} {% block link %}
<link rel="stylesheet" type="text/css" href="{% static 'css/text_annotation.css' %}" />
{% endblock %} {% block content %}
<main class="container-fluid p-0" id="text-app">
	{% if not exists %}
	<div class="alert alert-warning my-4 w-75 mx-auto d-flex gap-3 align-items-center" role="alert">
		<svg
			class="bi flex-shrink-0"
			xmlns="http://www.w3.org/2000/svg"
			height="1.6rem"
			fill="none"
			stroke="currentColor"
			viewBox="0 0 24 24"
		>
			<path
				stroke-linecap="round"
				stroke-width="1.5"
				d="m14.5 9.5-5 5m0-5 5 5M22 12c0 4.71 0 7.07-1.46 8.54C19.07 22 16.7 22 12 22c-4.71 0-7.07 0-8.54-1.46C2 19.07 2 16.7 2 12c0-4.71 0-7.07 1.46-8.54C4.93 2 7.3 2 12 2c4.71 0 7.07 0 8.54 1.46.97.98 1.3 2.35 1.4 4.54"
			/>
		</svg>

		<p class="m-0">Текст не найден</p>
	</div>
	{% else %}
	<!-- Toolbar for text -->
	<div class="bg-white p-3 mb-0 pb-0">
		<h3 class="text-primary">{{lang_name}} / {{text_info.text_type}} / {{text_info.text_name}}</h3>
		<h5 class="text-secondary mb-2">{{text_info.author_name}}</h5>
		<hr class="m-0" />
	</div>
	<div class="bg-white shadow-sm p-3 sticky-top mt-0">
		<div class="btn-group col-auto flex-wrap" role="group">
			<button
				type="button"
				class="btn btn-outline-primary dropdown col-auto shadow-none dropdown-toggle rounded-start rounded-0"
				data-bs-toggle="dropdown"
				aria-expanded="false"
			>
				Вид
			</button>
			<ul class="dropdown-menu">
				<li><h6 class="dropdown-header">Язык разметки</h6></li>
				<li>
					<div class="dropdown-item-text">
						<select id="lang-select" class="form-control" v-model="lang">
							<option id="foreign-option" value="foreign">{{lang_name}}</option>
							<option id="russian-option" value="rus">Русский</option>
						</select>
					</div>
				</li>
				<li><h6 class="dropdown-header">Компактный вид</h6></li>
				<li>
					<div class="dropdown-item-text">
						<div class="form-check form-switch">
							<input class="form-check-input shadow-none" type="checkbox" @change="toggleCompact()" />
						</div>
					</div>
				</li>
				<li><h6 class="dropdown-header">Части речи</h6></li>
				<li>
					<div class="dropdown-item-text">
						<div class="form-check form-switch">
							<input class="form-check-input shadow-none" type="checkbox" @change="togglePos()" />
						</div>
					</div>
				</li>
				<li><h6 class="dropdown-header">Ошибки</h6></li>
				<li>
					<div class="dropdown-item-text">
						<div class="form-check form-switch">
							<input
								class="form-check-input shadow-none"
								type="checkbox"
								checked
								@change="toggleErrors()"
							/>
						</div>
					</div>
				</li>
			</ul>

			<button
				type="button"
				class="btn btn-outline-primary dropdown col-auto shadow-none dropdown-toggle rounded-0"
				data-bs-toggle="dropdown"
				aria-expanded="false"
			>
				Текст
			</button>
			<ul class="dropdown-menu">
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Курс создания: </label>
						{{text_info.course}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Дата создания: </label>
						{{text_info.create_date}}
					</div>
				</li>
				<li><hr class="dropdown-divider" /></li>
				<li>
					<div class="dropdown-item-text text-center">
						<a href="{% url 'show_raw' text_id=text_id %}" class="link-primary btn shadow-none"
							>Исходный текст
						</a>
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<button
							class="link-primary btn shadow-none"
							onclick="process_part_of_speech(event, '{{language}}', '{{text_type}}', '{{text_id}}')"
						>
							Обновить частеречную разметку
						</button>
					</div>
				</li>
				{%if superuser%}
				<li>
					<div class="dropdown-item-text">
						<form
							method="post"
							novalidate
							action="{% url 'delete_text' %}"
							class="d-flex justify-content-center"
						>
							<input type="hidden" name="text_id" value="{{ text_id }}" />
							<button
								type="submit"
								class="link-danger btn shadow-none"
								onclick="return confirm('Удалить текст?')"
							>
								Удалить текст
							</button>
						</form>
					</div>
				</li>
				{%endif%}
			</ul>

			<button
				type="button"
				class="btn btn-outline-primary dropdown col-auto shadow-none dropdown-toggle rounded-0"
				data-bs-toggle="dropdown"
				aria-expanded="false"
			>
				Автор
			</button>
			<ul class="dropdown-menu">
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Имя: </label>
						{{text_info.author_name}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Группа: </label>
						{{text_info.group_number}}
					</div>
				</li>
				{%if text_owner or teacher and user.language_id == language.id_language %}
				<li><hr class="dropdown-divider" /></li>
				<li>
					<div class="dropdown-item-text text-center">
						<a href="{%url 'author_edit' text_id=text_id %}" class="link-primary btn shadow-none"
							>Изменить</a
						>
					</div>
				</li>
				{%endif%}
			</ul>

			<button
				type="button"
				class="btn btn-outline-primary dropdown col-auto shadow-none dropdown-toggle rounded-0"
				data-bs-toggle="dropdown"
				aria-expanded="false"
			>
				Проверка
			</button>
			<ul class="dropdown-menu">
				<li><h6 class="dropdown-header text-primary">Оценка работы</h6></li>
				{%if text_info.assessment%}
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Оценка: </label>
						{{text_info.assessment}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Полнота: </label>
						{{text_info.completeness}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Структура: </label>
						{{text_info.structure}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Связность: </label>
						{{text_info.coherence}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Проверяющий: </label>
						{{text_info.teacher_name}}
					</div>
				</li>
				{%else%}
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Оценка: </label>
						Не указано
					</div>
				</li>
				{%endif%}

				<li><h6 class="dropdown-header text-primary">Частеречная разметка</h6></li>
				{%if text_info.pos_check%}
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Статус: </label>
						<span class="text-success">Проверено</span>
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Проверяющий: </label>
						{{text_info.pos_check_name}}
					</div>
				</li>
				{%else%}
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Статус: </label>
						<span class="text-danger">Не проверено</span>
					</div>
				</li>
				{%endif%}

				<li><h6 class="dropdown-header text-primary">Разметка ошибок</h6></li>
				{%if text_info.error_check%}
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Статус: </label>
						<span class="text-success">Проверено</span>
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Проверяющий: </label>
						{{text_info.error_check_name}}
					</div>
				</li>
				{%else%}
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Статус: </label>
						<span class="text-danger">Не проверено</span>
					</div>
				</li>
				{%endif%} {%if ann_right %}
				<li><hr class="dropdown-divider" /></li>
				<li>
					<div class="dropdown-item-text text-center">
						<a href="{% url 'assessment_edit' text_id=text_id %}" class="link-primary btn shadow-none"
							>Изменить</a
						>
					</div>
				</li>
				{%endif%}
			</ul>

			{% if auto_degree%}
			<button
				type="button"
				class="btn btn-outline-primary dropdown col-auto shadow-none dropdown-toggle rounded-0"
				data-bs-toggle="dropdown"
				aria-expanded="false"
			>
				Автооценка
			</button>
			<ul class="dropdown-menu">
				<li><h6 class="dropdown-header text-primary">Грамматика</h6></li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Степень 1: </label>
						{{auto_grammatik.0}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Степень 2: </label>
						{{auto_grammatik.1}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Степень 3: </label>
						{{auto_grammatik.2}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Оценка: </label>
						{{auto_grammatik.3}}
					</div>
				</li>

				<li><h6 class="dropdown-header text-primary">Лексика</h6></li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Степень 1: </label>
						{{auto_lexik.0}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Степень 2: </label>
						{{auto_lexik.1}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Степень 3: </label>
						{{auto_lexik.2}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Оценка: </label>
						{{auto_lexik.3}}
					</div>
				</li>

				<li><h6 class="dropdown-header text-primary">Орфография и пунктуация</h6></li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Степень 1: </label>
						{{auto_orth.0}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Степень 2: </label>
						{{auto_orth.1}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Степень 3: </label>
						{{auto_orth.2}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Оценка: </label>
						{{auto_orth.3}}
					</div>
				</li>

				<li><h6 class="dropdown-header text-primary">Подсчёт ошибок</h6></li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Дискурс: </label>
						{{count_dis}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Пропуски: </label>
						{{count_skip}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Лишние элементы: </label>
						{{count_extra}}
					</div>
				</li>
			</ul>

			{%endif%}

			<button
				type="button"
				class="btn btn-outline-primary dropdown col-auto shadow-none dropdown-toggle rounded-end"
				data-bs-toggle="dropdown"
				aria-expanded="false"
			>
				Метаданные
			</button>
			<ul class="dropdown-menu">
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Эмоционально-физиологическое состояние: </label>
						{{text_info.emotional}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Место написания: </label>
						{{text_info.write_place}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Год изучения языка: </label>
						{{text_info.education_level}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Самооценивание: </label>
						{{text_info.self_rating}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<label class="text-secondary">Оценка задания студентом: </label>
						{{text_info.student_assessment}}
					</div>
				</li>
				{%if text_owner%}
				<li><hr class="dropdown-divider" /></li>
				<li>
					<div class="dropdown-item-text text-center">
						<a href="{%url 'meta_edit' text_id=text_id%}" class="link-primary btn shadow-none">Изменить</a>
					</div>
				</li>
				{%endif%}
			</ul>
		</div>
	</div>
	<!-- Text area -->
	<div>
		<h3 v-if="!text_data" class="text-secondary text-center my-5">Загрузка текста...</h3>
		<div v-else v-cloak><text-area :text_data="text_data" @refresh-text="refresh" /></div>
	</div>
	{% endif %}
</main>
{% endblock content %}

<!-- Scripts -->
{% block script %}
<script type="text/javascript">
	// Vue
	const Annotation = {
		delimiters: ['[[', ']]'],
		inject: ['errors', 'pos', 'compact', 'translate'],
		props: {
			annotation_data: Object,
			markup_data: Object
		},
		computed: {
			style() {
	       return 'color:' + getVisibleColor(this.markup_data.tag_color) +'; background-color: ' + this.markup_data.tag_color;
	     }
		},
		template: `
			<div v-if='(markup_data.markup_type == 1 && errors) || (markup_data.markup_type == 2 && pos)' class='annotation text-center px-2 py-0 rounded' :style='style'>
				<div v-if='compact'>[[markup_data.tag_text_abbrev]]</div>
				<div v-else-if='markup_data.markup_type == 1 && translate'>[[markup_data.tag_text_russian]]</div>
				<div v-else>[[markup_data.tag_text]]</div>
			</div>
		`
	}

	const NewTokenButton = {
		delimiters: ['[[', ']]'],
		inject: ['ann_right'],
		props: {
			parent_token_id: Number,
			position: String,
		},
		methods: {
			handleClick: async function() {
				await add_token(this.parent_token_id, this.position);
			  this.$emit('refresh-text');
			}
		},
		emits: ['refresh-text'],
		template: `
			<button @click='handleClick' v-if='ann_right' class='add-token-btn text-primary btn shadow-none px-0 mx-0' title='Добавить пустой токен'>
				<svg xmlns="http://www.w3.org/2000/svg" class='bi' height="1.2em" fill="none" stroke="currentColor" viewBox="0 0 24 24">
	 				<path stroke-linecap="round" stroke-width="1.5" d="M15 12h-3m0 0H9m3 0V9m0 3v3M7 3.338A9.954 9.954 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/>
				</svg>
			</button>
		`
	}

	const Token = {
		delimiters: ['[[', ']]'],
		props: {
	   	token_data: Object,
		},
		components: {
			NewTokenButton,
			Annotation
		},
		emits: ['refresh-text'],
		methods: {
			refresh() {
				this.$emit('refresh-text');
			}
		},
		mounted() {
			console.log('tokendata', this.token_data)
		},

		template: `
			<new-token-button @refresh-text="refresh" v-if='token_data.order_number === 0' :parent_token_id='token_data.token_id' position="left"/>
			<div class='d-flex flex-column justify-content-end gap-1'>
				<annotation v-for='[markup_id, markup] in token_data.markup' :key=markup_id :annotation_data=markup.annotation_data :markup_data=markup.markup_data />
				<button v-if='token_data.text !== ""' class='token shadow-sm px-2 py-1 rounded-2 btn' data-bs-toggle="button">[[token_data.text]]</button>
				<button v-else class='token shadow-sm text-secondary px-2 py-1 rounded-2 btn' data-bs-toggle="button">
					<svg xmlns="http://www.w3.org/2000/svg" class='bi' height="1em" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-width="1.5" d="m14.36 4.079.927-.927a3.932 3.932 0 0 1 5.561 5.561l-.927.927m-5.56-5.561s.115 1.97 1.853 3.707C17.952 9.524 19.92 9.64 19.92 9.64m-5.56-5.561L12 6.439m7.921 3.2-5.26 5.262L11.56 18l-.16.161c-.578.577-.867.866-1.185 1.114a6.554 6.554 0 0 1-1.211.749c-.364.173-.751.302-1.526.56l-3.281 1.094m0 0-.802.268a1.06 1.06 0 0 1-1.342-1.342l.268-.802m1.876 1.876-1.876-1.876m0 0 1.094-3.281c.258-.775.387-1.162.56-1.526.205-.43.456-.836.749-1.211.248-.318.537-.607 1.114-1.184L8.5 9.939"/>
					</svg>

				</button>
			</div>
			<new-token-button @refresh-text="refresh" :parent_token_id='token_data.token_id' position="right"/>
		`
	}

	const Sentence = {
		delimiters: ['[[', ']]'],
		components: {
			Token
		},
		props: {
	   sentence_data: Object,
		},
		data() {
			return {
			}
		},
		emits: ['refresh-text'],
		methods: {
			refresh() {
				this.$emit('refresh-text');
			}
		},
		template: `
		<div class='d-flex align-items-end gap-1'>
			<token @refresh-text="refresh" v-for='[token_id, token_data] in sentence_data' :key='token_id' :token_data='token_data' />
		</div>`
	}

	const TextArea = {
		delimiters: ['[[', ']]'],
		props: {
	   text_data: Object
		},
		components: {
			Sentence
		},
		emits: ['refresh-text'],
		methods: {
			refresh() {
				this.$emit('refresh-text');
			}
		},
		template: `
			<div class='table-responsive my-4'>
				<table class='table text-nowrap'>
					<tr v-for='(sentence, index) in text_data.sentences' :key='index'>
						<td class='pe-2 ps-4 text-secondary text-center col-auto'>[[index + 1]]</td>
						<td class='col-12'><sentence @refresh-text="refresh" :sentence_data=sentence /></td>
					</tr>
				</table>
			</div>
		`
	}

	Vue.createApp({
		delimiters: ['[[', ']]'],
		components: {
			TextArea
		},

		data() {
			return {
				text_data: null,
				text_id: {{text_id}},
				compact: false,
				pos: false,
				errors: true,
				lang: 'foreign'
			}
		},
		provide() {
			return {
				ann_right: '{{ann_right}}' === 'True',
				errors: Vue.computed(() => this.errors),
				pos: Vue.computed(() => this.pos),
				compact: Vue.computed(() => this.compact),
				translate: Vue.computed(() => this.lang === 'rus')
			}
		},
		methods: {
			async fetchTextData() {
	   		return await get_text_data(this.text_id).then(raw_data => format_text_data(raw_data));
	   	},
			async refresh() {
				const text_data = await this.fetchTextData();
				this.text_data = text_data;
			},

			toggleCompact() {
				this.compact = !this.compact;
			},
			togglePos() {
				this.pos = !this.pos;
			},
			toggleErrors() {
				this.errors = !this.errors;
			}
		},

		mounted() {
	   	this.refresh();
	 }
	}).mount('#text-app');


	// Text logic
	async function get_text_data(text_id) {
		const response = await axios({
			url: "{%url 'get_text' %}",
			method: 'POST',
			data: { text_id: text_id },
			headers: { 'X-CSRFToken': '{{csrf_token}}' },
		})
		.catch((error) => {
				console.log(error.message);
		});
		return response.data;
	}

	class TextElement {
		constructor (id, text, order_number) {
			this.token_id = id;
			this.markup = new Map();
			this.text = text;
			this.order_number = order_number;
		}

		add_markup_data(markup_id, markup_data) {
			if (this.markup.has(markup_id)) {
				this.markup.get(markup_id).markup_data = markup_data;
			}
			else {
				this.markup.set(markup_id, {
					annotation_data: null,
					markup_data: markup_data
				});
			}
		}

		add_annotation_data(markup_id, annotation_data) {
			if (this.markup.has(markup_id)) {
				this.markup.get(markup_id).annotation_data = annotation_data;
			}
			else {
				this.markup.set(markup_id, {
					annotation_data: annotation_data,
					markup_data: null
				});
			}
		}
	}

	async function format_text_data(raw_text_data) {
		console.log(raw_text_data)
		let sentences = [];

		for (let sentence of raw_text_data.sentences) {
			let sentence_elements = new Map();

			for (let token of sentence.tokens) {
				let element = new TextElement(token.token_id, token.text, token.order_number);
				if (token.markups_ids.trim() !== '') {
					for (let markup_id of token.markups_ids.trim().split(' ').map(Number)) {
						let markup_data = raw_text_data.markup_info[markup_id];
						element.add_markup_data(markup_id, markup_data);
					}
				}

				sentence_elements.set(token.token_id, element);
			}

			for (let annotation_array of sentence.annotations) {
				for (let annotation of annotation_array) {
					if (annotation.isann) {
						sentence_elements.get(annotation.token_id).add_annotation_data(annotation.ann_id, annotation);
					}
				}
			}
			sentences.push(sentence_elements);
		}

		return {sentences};
	}

	async function add_token(parent_token_id, position){
		return await axios({
				url:"{% url 'add_empty_token' %}",
				method: 'POST',
				data:{'parent_token': parent_token_id, 'append_position':position},
				headers: {"X-CSRFToken": "{{csrf_token}}"}
		}).catch((error) => {
			console.log(error.message);
		});
	 }

	 function process_part_of_speech(eventData, language, text_type, text_id) {
		eventData.preventDefault();

		if (!window.confirm('Вы действительно желаете обновить частеречную разметку? Старая разметка будет удалена')) {
			return;
		}

		let process_url = "{% url 'part_of_speech' %}";
		fetch(process_url, {
			method: 'POST',
			body: JSON.stringify({ language, text_type, text_id }),
		}).then(
			(response) => {
				if (response.ok) {
					window.alert('Частеречная разметка обновлена!');
					document.getElementById('update_part_of_speech_btn').style.display = 'block';
					return;
				} else {
					window.alert('Ошибка разметки текста: ' + response.statusText);
				}
			},
			(networkError) => {
				window.alert('Ошибка разметки текста: ' + networkError.message);
			}
		);
	}

	// Auxiliary methods
	function brightnessByColor (hexcolor) {
		const color = "" + hexcolor
		var m = color.substr(1).match(color.length == 7 ? /(\S{2})/g : /(\S{1})/g);
		if (m) {
			var r = parseInt(m[0], 16), g = parseInt(m[1], 16), b = parseInt(m[2], 16);
		}

		if (typeof r != "undefined") return ((r*299)+(g*587)+(b*114)) / 1000;
	}

	function getVisibleColor(color) {
		const brightness = brightnessByColor(color);
		if (brightness < 255 / 2) {
			return '#ffffff';
		}
		else {
			return '#000000';
		}
	}
</script>
{% endblock script %} {%block plugins%}
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
{%endblock plugins%}
